executor: flutter-ios
steps:
  - checkout-project
  - run:
      name: Install Github CLI
      command: brew install gh
  - run:
      name: Download Libqaul *.a File from latest Github Release
      command: |
        gh release download --pattern "*.a" --repo "$REPO_URL" --dir ../../rust/target/universal/release
  - install-flutter:
      version: "$FLUTTER_VERSION"
  - run: flutter doctor --verbose
  - run:
      name: "Prepare For Cache Key"
      command: |
        cat "$(find .. -iname "pubspec.lock" | head -n 1)" > pubspec.rev
  - restore_cache:
      name: Restore Flutter pub cache
      key: pub-cache-v3-{{ arch }}-{{ .Environment.CIRCLE_WORKING_DIRECTORY }}-{{ checksum "pubspec.rev" }}
  - run:
      name: Install Flutter Dependencies
      command: cd .. && flutter pub get
  - save_cache:
      name: Save Flutter pub cache
      key: pub-cache-v3-{{ arch }}-{{ .Environment.CIRCLE_WORKING_DIRECTORY }}-{{ checksum "pubspec.rev" }}
      paths:
        - << parameters.dart-tool-cache >>
        - << parameters.pub-cache >>
  - install-bundler-deps
  - install-cocoapods-deps
  - run:
      name: Build Flutter iOS Configuration
      command: flutter build ios --release --no-codesign --config-only
  - run:
      name: fastlane
      command: bundle exec fastlane $FASTLANE_LANE
  - store_artifacts:
      path: output
      destination: output
  - persist_to_workspace:
      root: ~/qaul.net
      paths:
        - qaul_ui/ios/output/gym/Runner.ipa
